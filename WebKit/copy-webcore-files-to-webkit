#!/usr/bin/perl -w

use strict;
use Cwd;
use File::Basename;

my $ProgramName = 'copy-webcore-files-to-webkit';

my %WebCoreFiles = (
    'kwq/DOM.h' => 'DOM.subproj/DOM.h',
    'kwq/DOM-compat.h' => 'DOM.subproj/DOM-compat.h',
    'kwq/DOMCSS.h' => 'DOM.subproj/DOMCSS.h',
    'kwq/DOMCore.h' => 'DOM.subproj/DOMCore.h',
    'kwq/DOMEvents.h' => 'DOM.subproj/DOMEvents.h',
    'kwq/DOMExtensions.h' => 'DOM.subproj/DOMExtensions.h',
    'kwq/DOMHTML.h' => 'DOM.subproj/DOMHTML.h',
    'kwq/DOMPrivate.h' => 'DOM.subproj/DOMPrivate.h',
    'kwq/DOMRange.h' => 'DOM.subproj/DOMRange.h',
    'kwq/DOMStylesheets.h' => 'DOM.subproj/DOMStylesheets.h',
    'kwq/DOMTraversal.h' => 'DOM.subproj/DOMTraversal.h',
    'kwq/DOMViews.h' => 'DOM.subproj/DOMViews.h',
    'kwq/WebDashboardRegion.h' => 'WebCoreSupport.subproj/WebDashboardRegion.h',
);

my %JavaScriptCoreFiles = (
    'bindings/npruntime.h' => 'Plugins.subproj/npruntime.h',
    'bindings/npapi.h' => 'Plugins.subproj/npapi.h',
    'bindings/objc/WebScriptObject.h' => 'Plugins.subproj/WebScriptObject.h',
);

my $JavaScriptCorePath = '';
my $WebCorePath = '';
my $WebKitPath = '';

CheckInWebKit();
CheckWebCoreFound();
CheckJavaScriptCoreFound();
CopyFilesIfNeeded();

#=======================================================================================
# subroutines

sub Fail {
    my ($say) = @_;
    Say("*** $ProgramName: $say");
    exit(-1);
}

sub Say {
    my ($say) = @_;
    print STDERR $say, "\n";
}

sub CheckInWebKit {
    if (cwd() =~ /WebKit$/) {
        # ok...we're in WebCore
        $WebKitPath = cwd();
    }
    else {
        Say("*** $ProgramName: not being run from WebKit directory. Cannot copy, exiting...");
        exit(0);
    }
}

sub CheckWebCoreFound {
    my $path = cwd();
    $path = dirname($path) . '/WebCore';
    if (-d $path) {
        # ok...WebCore is where we expect it
        $WebCorePath = $path;
    }
    else {
        Say("*** $ProgramName: WebCore is not a sibling directory to WebKit. Cannot copy, exiting...");
        exit(0);
    }
}

sub CheckJavaScriptCoreFound {
    my $path = cwd();
    $path = dirname($path) . '/JavaScriptCore';
    if (-d $path) {
        # ok...WebCore is where we expect it
        $JavaScriptCorePath = $path;
    }
    else {
        Say("*** $ProgramName: JavaScriptCore is not a sibling directory to WebKit. Cannot copy, exiting...");
        exit(0);
    }
}

sub CopyFilesIfNeeded {
    # Only copy files if the dest file does not exist
    # or the source file is different than the dest file
    my $blab = 0;
    
    for my $file (keys(%WebCoreFiles)) {
        my $source = "$WebCorePath/$file";
        my $dest = "$WebKitPath/$WebCoreFiles{$file}";
        if (! -f $source) {
            Fail("$source is not a plain file");    
        }
        if (-e $dest && ! -f $dest) {
            Fail("$dest is not a plain file");    
        }

        ExecuteCommand("sed -e 's%#import .*<WebCore/\\(.*\\)>%#import <WebKit/\\1>%' -e 's%#import .*<JavaScriptCore/\\(.*\\)>%#import <WebKit/\\1>%' $source > $dest-X");
        if (! -e $dest || system("cmp $dest $dest-X > /dev/null 2>&1")){
            ExecuteCommand("cp -f $dest-X $dest");
       }
       ExecuteCommand("rm $dest-X");

    }

    for my $file (keys(%JavaScriptCoreFiles)) {
        my $source = "$JavaScriptCorePath/$file";
        my $dest = "$WebKitPath/$JavaScriptCoreFiles{$file}";
        if (! -f $source) {
            Fail("$source is not a plain file");    
        }
        if (-e $dest && ! -f $dest) {
            Fail("$dest is not a plain file");    
        }
        
        ExecuteCommand("sed -e 's%#import .*<WebCore/\\(.*\\)>%#import <WebKit/\\1>%'  -e 's%#import .*<JavaScriptCore/\\(.*\\)>%#import <WebKit/\\1>%' $source > $dest-X");
        if (! -e $dest || system("cmp $dest $dest-X > /dev/null 2>&1")){
            ExecuteCommand("cp -f $dest-X $dest");
       }
       ExecuteCommand("rm $dest-X");
    }
}

sub ExecuteCommand {
    my ($cmd) = @_;
    my $result = system($cmd);
    if ($result != 0) {
        Say($cmd);
        Fail("error: $result");
        exit($result);
    }
}
