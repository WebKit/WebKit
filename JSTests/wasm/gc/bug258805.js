//@ skip unless $isSIMDPlatform
//@ runWebAssemblySuite("--useWebAssemblyTypedFunctionReferences=true", "--useWebAssemblyGC=true")

import * as assert from "../assert.js";

function module(bytes, valid = true) {
  let buffer = new ArrayBuffer(bytes.length);
  let view = new Uint8Array(buffer);
  for (let i = 0; i < bytes.length; ++i) {
    view[i] = bytes.charCodeAt(i);
  }
  return new WebAssembly.Module(buffer);
}

// Neither GC proposal spec decoder nor wasm-dis could decode.
// (due to use of threads & exception opcodes)
assert.throws(
   () => new WebAssembly.Instance(module("\x00\x61\x73\x6d\x01\x00\x00\x00\x01\x8e\x81\x80\x80\x00\x0c\x50\x00\x5f\x03\x7b\x01\x7f\x01\x7b\x00\x50\x00\x5f\x03\x7f\x00\x7f\x01\x7c\x01\x50\x00\x5f\x03\x7f\x00\x7c\x00\x7c\x00\x50\x00\x5e\x6c\x01\x50\x00\x5e\x7c\x01\x50\x00\x5e\x7f\x01\x50\x00\x60\x03\x7f\x7f\x7f\x01\x7f\x50\x00\x60\x06\x63\x02\x7b\x63\x00\x63\x02\x64\x04\x7f\x0f\x7c\x64\x6e\x6d\x7b\x64\x02\x7f\x7f\x7f\x7f\x7f\x7f\x7f\x7f\x6e\x64\x05\x50\x00\x60\x03\x64\x6b\x64\x6e\x7d\x00\x50\x00\x60\x09\x7c\x7f\x64\x6c\x64\x6f\x64\x08\x7f\x7d\x7f\x7f\x00\x60\x00\x00\x50\x00\x60\x01\x6c\x0f\x7c\x64\x6e\x6d\x7b\x64\x02\x7f\x7f\x7f\x7f\x7f\x7f\x7f\x7f\x6e\x64\x05\x03\x85\x80\x80\x80\x00\x04\x06\x07\x08\x09\x04\x85\x80\x80\x80\x00\x01\x70\x01\x04\x04\x05\x84\x80\x80\x80\x00\x01\x01\x10\x20\x0d\x85\x80\x80\x80\x00\x02\x00\x0a\x00\x0a\x07\x88\x80\x80\x80\x00\x01\x04\x6d\x61\x69\x6e\x00\x00\x09\x94\x80\x80\x80\x00\x01\x06\x00\x41\x00\x0b\x70\x04\xd2\x00\x0b\xd2\x01\x0b\xd2\x02\x0b\xd2\x03\x0b\x0c\x01\x01\x0a\xf2\x83\x80\x80\x00\x04\x08\x00\x41\x8f\xa8\xc8\xc7\x02\x0b\xb8\x02\x01\x01\x7e\xd0\x03\xd0\x70\x41\xce\x00\xfc\x0f\x00\xfb\x0b\x03\x02\x0b\x1a\x44\xb8\x19\xe7\x31\xfe\x0f\xa7\x42\x44\x96\x94\x9f\x03\xc8\x86\x9c\xa7\x41\xa6\x82\xef\x97\x7c\xfd\x0f\x41\xc8\xdd\xcf\xbc\x06\x41\xa1\x89\x98\xf3\x7b\xfd\x0f\xfb\x00\x00\xd0\x6d\x41\x82\xc3\x88\x83\x78\xfd\x0f\x41\xb2\x89\xbd\xa3\x7f\x44\xe7\x54\xa4\xc4\xfc\xf8\x44\x5a\x44\x30\xe3\x76\xae\x7c\x35\x07\xc6\xfb\x00\x02\x41\xe1\xdd\xc0\xf7\x78\x41\xfb\x85\xfe\xdd\x06\x41\x87\x92\x8e\x93\x7a\x41\xdf\x85\x94\xc1\x02\x41\xfb\x90\x80\xaa\x78\x41\xe6\xb0\x88\xf5\x7c\x41\xf1\xfa\x94\xba\x7f\x41\x8d\xe2\xa4\xe4\x7b\xd0\x6e\x41\xed\xeb\xc9\xe9\x07\x41\xa2\xbd\xcf\xa7\x04\x41\x14\x6f\xfb\x09\x05\xd0\x6e\xd4\x01\x1a\x1a\x1a\x1a\x1a\x1a\x1a\x1a\x1a\x1a\x1a\x1a\x1a\x1a\x1a\xaa\x28\x01\xdd\xf1\xa7\xac\x02\x69\x41\x89\x7f\xfe\x1e\x01\xdb\xd1\xc1\xbf\x03\xfb\x1c\xd0\x6d\x41\xcf\xc1\xa7\xcf\x78\xfd\x0f\x41\xc8\x84\x84\xf8\x7d\x44\xfd\x50\xde\x63\x02\x5b\xba\xb8\x44\xf8\x3b\xfc\x12\xdd\x3d\x2e\x22\xfb\x00\x02\x41\xcc\x83\x97\x60\x41\x98\xa3\xb0\xeb\x7c\x41\xb2\xd7\xef\x68\x41\x86\x9f\xde\xcf\x79\x41\xf7\x84\xe9\x94\x7d\x41\xb1\x80\xd5\xa3\x02\x41\xbc\xb5\xd9\x80\x06\x41\xe5\xcf\xdb\xb7\x05\xd0\x6e\x41\xa8\x9f\xb0\x08\x41\xf8\xe9\x88\x91\x06\x41\x14\x6f\xfb\x09\x05\x0b\x0b\x31\x00\x41\x95\xcc\xc1\xea\x78\xfd\x0f\xfd\xc3\x01\x41\xd9\x9b\xec\xb0\x7d\xfd\x0f\xfd\x0c\xec\x2b\xd3\x07\x79\x1c\x75\x06\xd7\x00\x39\xab\x33\xca\x8e\xdb\xfd\x6f\xfd\x0b\x02\xc3\x8b\xb1\xe3\x03\x0b\x7b\x00\x0c\x00\x41\x9a\xc3\x88\xe6\x07\x42\x97\xc5\x87\xf0\xf9\x8a\xf7\xec\x42\xfe\x1b\x00\xbe\xae\xba\xde\x0a\xd0\x04\xd0\x70\x41\x9d\xcc\x90\x81\x06\xfc\x0f\x00\xd0\x04\x41\xaa\xfc\xcb\xad\x7c\x41\xde\x8f\xcd\xa8\x03\xfb\x11\x04\x04\xd0\x03\x41\x96\xb7\xb4\x88\x7d\xd0\x6c\x41\xe8\xd0\x83\xbf\x06\x41\x14\x6f\xfb\x09\x03\x41\xcb\xe1\x8d\xa5\x7f\x41\xa9\x96\xfd\x41\xfb\x11\x03\x03\x41\xf4\xc1\xc6\xa4\x02\x42\x96\xe9\x82\xae\xb1\x9e\xe9\xe0\x81\x7f\x42\x5d\x54\x36\x02\xef\x9b\xbb\x9b\x02\x0b\x0b\x83\x80\x80\x80\x00\x01\x01\x00")),
   WebAssembly.CompileError,
   // There are multiple errors so we use a generic message here.
   "WebAssembly.Module doesn't"
);
