2022-02-24  Devin Rousso  <drousso@apple.com>

        [MacCatalyst] REGRESSION(r290091): sometimes can crash if `WKWebView` is deallocated before the next visible content rect update
        https://bugs.webkit.org/show_bug.cgi?id=237126
        <rdar://problem/89345853>

        Reviewed by Tim Horton.

        * TestWebKitAPI/Tests/WebKitCocoa/WKWebViewResize.mm: Added.
        (TEST.WKWebViewResize.DoesNotAssertInDeallocAfterChangingFrame):
        (TEST.WKWebViewResize.DoesNotAssertInDeallocAfterChangingBounds):

        * TestWebKitAPI/SourcesCocoa.txt:
        * TestWebKitAPI/TestWebKitAPI.xcodeproj/project.pbxproj:

2022-02-24  J Pascoe  <j_pascoe@apple.com>

        Add myself (John Pascoe) to watchlist for authentication and WebCrypto
        https://bugs.webkit.org/show_bug.cgi?id=237121
        rdar://problem/89385797

        Reviewed by Alexey Proskuryakov.

        * Scripts/webkitpy/common/config/watchlist:

2022-02-22  Jonathan Bedard  <jbedard@apple.com>

        [run-webkit-tests] Use Python 3 (Part 2)
        https://bugs.webkit.org/show_bug.cgi?id=226658
        <rdar://problem/78882016>

        Reviewed by Ryan Haddad.

        * Scripts/run-webkit-tests: Change shebang to Python 3.

2022-02-24  Kimmo Kinnunen  <kkinnunen@apple.com>

        Thread safety analysis to assert "code is run sequentially" is not useful when code is mainly run with WorkQueues
        https://bugs.webkit.org/show_bug.cgi?id=236832

        Reviewed by Antti Koivisto.

        Test the added functionality to be able to use assertIsCurrent(thread/workQueue).

        Fix WTF_WorkQueue.DestroyDispatchedOnDispatchQueue test, it is now able to make the assertion correctly.
        - The object is created somewhere that is not the tested WorkQueue
        - The object is destroyed in the tested WorkQueue

        * Scripts/generate-gpup-webgl:
        * TestWebKitAPI/Tests/WTF/Threading.cpp:
        (TestWebKitAPI::TEST):
        * TestWebKitAPI/Tests/WTF/WorkQueue.cpp:
        (TestWebKitAPI::TEST):

2022-02-23  Chris Dumez  <cdumez@apple.com>

        Adopt more widely the new URL constructor that takes in a String
        https://bugs.webkit.org/show_bug.cgi?id=237099

        Reviewed by Darin Adler.

        * TestWebKitAPI/Tests/WTF/URLParser.cpp:
        (TestWebKitAPI::checkURL):
        (TestWebKitAPI::checkURLDifferences):
        (TestWebKitAPI::testUserPassword):
        * TestWebKitAPI/Tests/WTF/cocoa/URLExtras.mm:
        (TestWebKitAPI::TEST):
        * TestWebKitAPI/Tests/WebCore/ContentExtensions.cpp:
        (TestWebKitAPI::mainDocumentRequest):
        (TestWebKitAPI::subResourceRequest):
        (TestWebKitAPI::requestInTopAndFrameURLs):
        (TestWebKitAPI::TEST_F):
        * TestWebKitAPI/Tests/WebCore/RegistrableDomain.cpp:
        (TestWebKitAPI::TEST):
        * TestWebKitAPI/Tests/WebCore/SecurityOrigin.cpp:
        (TestWebKitAPI::TEST_F):
        * TestWebKitAPI/Tests/WebCore/curl/Cookies.cpp:
        (TestWebKitAPI::Curl::TEST_F):
        * TestWebKitAPI/Tests/WebKitCocoa/ApplicationManifest.mm:
        (TestWebKitAPI::TEST):
        * TestWebKitAPI/Tests/WebKitCocoa/TestSOAuthorization.mm:
        (TestWebKitAPI::TEST):
        * TestWebKitAPI/Tests/mac/SSLKeyGenerator.mm:

2022-02-23  Wenson Hsieh  <wenson_hsieh@apple.com>

        REGRESSION (288925?): [iOS] TestWebKitAPI.RequestTextInputContext.TextInteraction_FocusingReadOnlyElementShouldScrollToReveal is failing
        https://bugs.webkit.org/show_bug.cgi?id=237069
        rdar://89325305

        Reviewed by Kate Cheney.

        This iOS API test occasionally fails in some test runners in automation, due to `didScroll` still being false at
        the end of the test. While I was unable to reproduce (both locally, and using EWS test runners), from code
        inspection this test appears to be inherently flaky since the scrolling is triggered via editor state updates
        propagated through remote layer tree commits; however, the test only verifies that scrolling occurs after one
        IPC round-trip between the web and UI processes (due to the call to `-stringByEvaluatingJavaScript:`).

        Since the regression point is suspiciously close to r288925, it's possible that the optimizations introduced in
        r288925 removed an extra sync IPC round-trip to the web process and back when requesting an autocorrection
        context after element focus, which would make this flakiness easier to reproduce in some configurations.

        In any case, one speculative fix for this test is to simply wait for the scrolling to occur, instead of assuming
        that it occurs after a single IPC round-trip.

        * TestWebKitAPI/Tests/WebKitCocoa/RequestTextInputContext.mm:
        (TestWebKitAPI::TEST):

2022-02-23  Jonathan Bedard  <jbedard@apple.com>

        [run-webkit-tests] Catch OSError when sampling
        https://bugs.webkit.org/show_bug.cgi?id=237087
        <rdar://problem/89357299>

        Reviewed by Aakash Jain.

        * Scripts/webkitpy/port/darwin.py:
        (DarwinPort.sample_process): Catch OSError when either sampling a
        process or running spindump. These errors indicate the error gathering process
        failed, but such a failure should not be fatal to the entire test run.

2022-02-23  J Pascoe  <j_pascoe@apple.com>

        [WebAuthn] userHandle not marked nullable in _WKWebAuthenticationAssertionResponse
        https://bugs.webkit.org/show_bug.cgi?id=237043
        rdar://89317740

        Reviewed by Brent Fulgham.

        Create tests to check for null userHandle.

        * TestWebKitAPI/Tests/WebKitCocoa/_WKWebAuthenticationPanel.mm:
        (TestWebKitAPI::TEST):

2022-02-23  Philippe Normand  <pnormand@igalia.com>

        [GStreamer] De-initialize GStreamer before terminating WebProcess
        https://bugs.webkit.org/show_bug.cgi?id=237084

        Reviewed by Carlos Garcia Campos.

        * flatpak/flatpakutils.py:
        (WebkitFlatpak.setup_gstbuild): Do not add extra quotes to GST_TRACERS, this is not supposed
        to store paths.

2022-02-23  Alex Christensen  <achristensen@webkit.org>

        Call WKNavigationDelegate.didFailProvisionalNavigation even after a cross-origin navigation with COOP
        https://bugs.webkit.org/show_bug.cgi?id=237071
        <rdar://88652375>

        Reviewed by Chris Dumez.

        * TestWebKitAPI/Tests/WebKitCocoa/Navigation.mm:
        (TEST):

2022-02-23  Angelos Oikonomopoulos  <angelos@igalia.com>

        [JSC] Set ssh keepalive in run-jsc-stress-tests
        https://bugs.webkit.org/show_bug.cgi?id=237031

        Reviewed by Adrian Perez de Castro.

        If a remote goes down after an ssh connection has been established, we
        need to be able to detect that. Keep the common ssh config options in
        one constant and add ServerAliveInterval=30 to it.

        While here, change sshRead to execute ssh directly (instead of
        going through the shell). Similarly, don't open-code the read
        loop, just call IO.read.

        * Scripts/run-jsc-stress-tests:

2022-02-23  Kimmo Kinnunen  <kkinnunen@apple.com>

        Fix GPUP WebGL generator script wrt uninitialised sized span
        https://bugs.webkit.org/show_bug.cgi?id=235889

        Reviewed by Antti Koivisto.
        Fix the generator. The r290328 only edited the generated files.
        Add a other hunk missing from r290175.

        * Scripts/generate-gpup-webgl:

2022-02-23  Zan Dobersek  <zdobersek@igalia.com>

        [GStreamer] Add WebKitDMABufVideoSink
        https://bugs.webkit.org/show_bug.cgi?id=236883

        Reviewed by Philippe Normand.

        * Scripts/webkitpy/style/checker.py:
        Add two additional files under the GObject-style exceptions.

2022-02-23  Kimmo Kinnunen  <kkinnunen@apple.com>

        Thread safety analysis macros are confusing for non-Lock use-cases
        https://bugs.webkit.org/show_bug.cgi?id=237022

        Reviewed by Chris Dumez.

        * Scripts/webkitpy/style/checkers/cpp.py:
        (check_identifier_name_in_declaration):
        * TestWebKitAPI/Tests/WTF/ThreadAssertionsTest.cpp:
        (TestWebKitAPI::WTF_REQUIRES_CAPABILITY):

2022-02-23  Youenn Fablet  <youenn@apple.com>

        Enable WebRTCRemoteVideoFrameEnabled by default in WebKitTestRunner
        https://bugs.webkit.org/show_bug.cgi?id=236969

        Reviewed by Eric Carlson.

        * WebKitTestRunner/TestOptions.cpp:

2022-02-22  Chris Dumez  <cdumez@apple.com>

        Drop StringHasher::hashMemory() and use the modern Hasher instead
        https://bugs.webkit.org/show_bug.cgi?id=237049

        Reviewed by Sam Weinig.

        * TestWebKitAPI/Tests/WTF/StringHasher.cpp:

2022-02-22  Ryan Haddad  <ryanhaddad@apple.com>

        REGRESSION(r289580): [ iOS macOS ] TestWebKitAPI.IPCTestingAPI.CanReceiveSharedMemory is a constant timeout
        https://bugs.webkit.org/show_bug.cgi?id=236744

        Unreviewed test gardening.

        * TestWebKitAPI/Tests/WebKitCocoa/IPCTestingAPI.mm: Disable the test.
        (TEST):

2022-02-17  Ryan Haddad  <ryanhaddad@apple.com>

        Remove dormant queues from bot watchers dashboard
        https://bugs.webkit.org/show_bug.cgi?id=236809

        Reviewed by Alexey Proskuryakov.

        * CISupport/build-webkit-org/public_html/dashboard/Scripts/Dashboard.js:
        * CISupport/build-webkit-org/public_html/dashboard/Scripts/WebKitBuildbot.js:
        (WebKitBuildbot):
        * Tools/CISupport/build-webkit-org/public_html/dashboard/Styles/Main.css:

2022-02-22  Jonathan Bedard  <jbedard@apple.com>

        [git-webkit] Link to GitHub wiki
        https://bugs.webkit.org/show_bug.cgi?id=237048
        <rdar://problem/89307995>

        Reviewed by Ryan Haddad.

        * Scripts/libraries/webkitscmpy/setup.py: Bump version.
        * Scripts/libraries/webkitscmpy/webkitscmpy/__init__.py: Ditto.
        * Scripts/libraries/webkitscmpy/webkitscmpy/program/setup.py:
        (Setup.main): Add GitHub wiki link.
        * Scripts/libraries/webkitscmpy/webkitscmpy/test/setup_unittest.py:
        (TestSetup.test_github):

2022-02-22  Philippe Normand  <pnormand@igalia.com>

        [GStreamer] Switch media player to playbin3
        https://bugs.webkit.org/show_bug.cgi?id=236884

        Reviewed by Xabier Rodriguez-Calvar.

        Replace WEBKIT_GST_USE_PLAYBIN3 with WEBKIT_GST_USE_PLAYBIN2 that allows to opt-out of
        playbin3, if this is desired.

        * Scripts/webkitpy/port/gtk.py:
        (GtkPort.setup_environ_for_server):
        * Scripts/webkitpy/port/wpe.py:
        (WPEPort.setup_environ_for_server):

2022-02-22  Jonathan Bedard  <jbedard@apple.com>

        [git-webkit] Extract revision from `git svn dcommit`
        https://bugs.webkit.org/show_bug.cgi?id=236849
        <rdar://problem/89155179>

        Reviewed by Ryan Haddad.

        * Scripts/libraries/webkitscmpy/setup.py: Bump version.
        * Scripts/libraries/webkitscmpy/webkitscmpy/__init__.py: Ditto.
        * Scripts/libraries/webkitscmpy/webkitscmpy/mocks/local/git.py:
        (Git): Thoroughly mock `dcommit`
        * Scripts/libraries/webkitscmpy/webkitscmpy/program/land.py:
        (Land.main): Extract committed SVN revision from `git svn dcommit` command to accurately
        match landed commits to the pull request that generated them.
        * Scripts/libraries/webkitscmpy/webkitscmpy/test/land_unittest.py:
        (repository): Add revision to local commit.

2022-02-22  Dean Jackson  <dino@apple.com>

        Filter some build output from JSC
        https://bugs.webkit.org/show_bug.cgi?id=236885

        Reviewed by Simon Fraser.

        Add some filter rules for recently added output. In particular:
        - whatever prints out the build command
        - python executables now having the version numbers in the binary
        - creating entitlements files

        * Scripts/filter-build-webkit:
        (shouldIgnoreLine):

2022-02-22  Aditya Keerthi  <akeerthi@apple.com>

        [iOS] Adopt new _UITextSearching method for range comparison
        https://bugs.webkit.org/show_bug.cgi?id=237012
        rdar://88442811

        Reviewed by Devin Rousso.

        Ensure TestSearchAggregator conforms to _UITextSearchAggregator.

        * TestWebKitAPI/Tests/WebKitCocoa/FindInPage.mm:
        (-[TestSearchAggregator initWithCompletionHandler:]):
        (-[TestSearchAggregator allFoundRanges]):
        (-[TestSearchAggregator invalidateFoundRange:inDocument:]):
        (-[TestSearchAggregator invalidate]):
        (textRangesForQueryString):
        (-[TestSearchAggregator foundRanges]): Deleted.

2022-02-22  Angelos Oikonomopoulos  <angelos@igalia.com>

        [JSC] Guard against dead remotes in numberOfProcessors
        https://bugs.webkit.org/show_bug.cgi?id=236643

        Reviewed by Adrian Perez de Castro.

        Instead of using only the first remote (and then defaulting to 1 when
        it happens to not respond), try all the remotes in sequence.

        Also, instead of trying the sysctl version on all hosts first and
        only try nproc after sysctl has failed on all hosts, combine
        sysctl and nproc in one command to speed things along.

        This change also removes the numProcessors == 0 typo in the rescue
        path.

        * Scripts/run-jsc-stress-tests:

2022-02-22  Carlos Garcia Campos  <cgarcia@igalia.com>

        [GTK] Can't run performance tests due to a11y errors
        https://bugs.webkit.org/show_bug.cgi?id=230705

        Reviewed by Sergio Villar Senin.

        Disable a11y in WTR since it's no longer nedded with ATSPI.

        * WebKitTestRunner/gtk/main.cpp:
        (main):
        * WebKitTestRunner/wpe/main.cpp:
        (main):

2022-02-21  Brandon Stewart  <brandonstewart@apple.com>

        Use ArgumentParser for parsing args in generate-compile-commands
        https://bugs.webkit.org/show_bug.cgi?id=236995

        Reviewed by Alexey Proskuryakov.

        Use argument parser instead of sys.argv[1] for getting build dir.

        * Scripts/generate-compile-commands:

2022-02-21  Wenson Hsieh  <wenson_hsieh@apple.com>

        [iOS] Adjust some behaviors around the "Markup Image" action in the callout bar
        https://bugs.webkit.org/show_bug.cgi?id=236980

        Reviewed by Aditya Keerthi.

        Add an API test to verify that "Markup Image" appears as the first non-default callout bar item when a single
        image element is in the selection range. The test is comprised of three parts:

        1. Select just a single image, and expect the "Markup Image" item.
        2. Select all images in the document, and expect no "Markup Image" item.
        3. Select a single image and some surrounding text, and expect the "Markup Image" item.

        See WebKit/ChangeLog for more details.

        * TestWebKitAPI/Tests/WebKitCocoa/ImageAnalysisTests.mm:
        (TestWebKitAPI::createWebViewWithTextRecognitionEnhancements):
        (TestWebKitAPI::swizzledSetMenuItems):
        (TestWebKitAPI::TEST):
        * TestWebKitAPI/Tests/WebKitCocoa/multiple-images.html:

        Add some text before and after each image so that we can select a single image alongside some text, and exercise
        the changes in `WebPage::getPlatformEditorState` (see WebKit changes for more information).

2022-02-21  Jon Lee  <jonlee@apple.com>

        Add test name to the image diff template
        https://bugs.webkit.org/show_bug.cgi?id=237003

        Reviewed by Sam Weinig.

        * Scripts/webkitpy/layout_tests/controllers/test_result_writer.py:
        (TestResultWriter.write_image_diff_files):

== Rolled over to ChangeLog-2022-02-22 ==
