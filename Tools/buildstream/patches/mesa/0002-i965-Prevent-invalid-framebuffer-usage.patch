From f9d0061833089ee67bdfdfa4446f7a3f46780370 Mon Sep 17 00:00:00 2001
From: Miguel Gomez <magomez@igalia.com>
Date: Thu, 3 Jun 2021 16:44:30 +0200
Subject: [PATCH] i965: Prevent invalid framebuffer usage

When a surfaceless context is in use, driDrawablePriv might be NULL, so needs to
be checked before calling dri2InvalidateDrawable. Same for read calls.
---
 src/mesa/drivers/dri/i965/intel_buffers.c | 6 ++++--
 1 file changed, 4 insertions(+), 2 deletions(-)

diff --git a/src/mesa/drivers/dri/i965/intel_buffers.c b/src/mesa/drivers/dri/i965/intel_buffers.c
index dae56e3362c..3898c32856a 100644
--- a/src/mesa/drivers/dri/i965/intel_buffers.c
+++ b/src/mesa/drivers/dri/i965/intel_buffers.c
@@ -42,7 +42,8 @@ intelDrawBuffer(struct gl_context *ctx)
        * time, invalidate our DRI drawable so we'll ask for new buffers
        * (including the fake front) before we start rendering again.
        */
-      dri2InvalidateDrawable(brw->driContext->driDrawablePriv);
+      if (brw->driContext->driDrawablePriv)
+          dri2InvalidateDrawable(brw->driContext->driDrawablePriv);
       intel_prepare_render(brw);
    }
 }
@@ -58,7 +59,8 @@ intelReadBuffer(struct gl_context * ctx, GLenum mode)
        * time, invalidate our DRI drawable so we'll ask for new buffers
        * (including the fake front) before we start reading again.
        */
-      dri2InvalidateDrawable(brw->driContext->driReadablePriv);
+      if (brw->driContext->driDrawablePriv)
+          dri2InvalidateDrawable(brw->driContext->driReadablePriv);
       intel_prepare_render(brw);
    }
 }
-- 
2.31.1

