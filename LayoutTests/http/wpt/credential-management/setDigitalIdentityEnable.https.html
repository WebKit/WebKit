<!DOCTYPE html>
<html>
    <head>
        <title>
            Check that parts of the Digital Identity API are not exposed by
            setting
        </title>
    </head>
    <script>
        testRunner.dumpAsText();
        testRunner.waitUntilDone();

        const idlInterfaces = [
            {
                name: "DigitalIdentity",
                proto: "Credential",
            },
            {
                name: "Identity",
                proto: "Credential",
            },
        ];

        function checkPrototype(context, interfaceName, expectedProto) {
            const isInstance =
                context[interfaceName].prototype instanceof
                context[expectedProto];
            if (!isInstance) {
                console.log(
                    `FAIL: expected ${interfaceName}'s prototype interface to be ${expectedProto}.`
                );
            }
        }

        idlInterfaces
            .filter(({ name }) => window[name])
            .forEach((name) => {
                console.log(
                    `FAIL: ${name} interface must not be exposed by default.`
                );
            });

        window.internals.settings.setDigitalIdentityEnabled(true);

        async function checkIFrame() {
            const iframeWin = document.querySelector("iframe").contentWindow;

            if (iframeWin.navigator.credentials.requestIdentity) {
                console.log(
                    "FAIL: navigator.credentials.requestIdentity() was removed from the spec!"
                );
            }

            try {
                idlInterfaces
                    .filter(({ name }) => !iframeWin[name])
                    .forEach(({ name, proto }) => {
                        console.log(
                            `FAIL: expected "${name}" interface to be exposed on iframeWin. Was exposed by pref.`
                        );
                    });
            } catch (err) {
                console.log(`FAIL: ${err}`);
            } finally {
                testRunner.notifyDone();
            }
            console.log("Test finished");
        }
    </script>
    <body>
        <iframe src="about:blank" onload="checkIFrame()"></iframe>
    </body>
</html>
