<!DOCTYPE html>
<body>
<script src="/resources/testharness.js"></script>
<script src="/resources/testharnessreport.js"></script>
<script>
function with_iframe(url, allow) {
    let frame = document.createElement('iframe');
    frame.src = url;
    frame.setAttribute('allow', allow);
    return new Promise(resolve => {
        frame.onload = () => { resolve(frame); };
        document.body.appendChild(frame);
    });
}

promise_test(async () => {
    navigator.audioSession.type = "play-and-record";
    await navigator.mediaDevices.getUserMedia({ audio: true });

    const frame1 = await with_iframe("http://localhost:8080/webrtc/resources/audioSessionFrame.html", "microphone:'none'");
    const result1 = await new Promise(resolve => window.onmessage = (event) => resolve(event.data));
    frame1.remove();

    const frame2 = await with_iframe("http://localhost:8080/webrtc/resources/audioSessionFrame.html", "microphone");
    const result2 = await new Promise(resolve => window.onmessage = (event) => resolve(event.data));
    frame2.remove();

    assert_equals(result1.type, "auto", "result1 type");
    assert_equals(result1.state, "inactive", "result1 state");

    assert_equals(result2.type, "auto", "result2 type");
    assert_equals(result2.state, "inactive", "result2 state");

    assert_equals(navigator.audioSession.type, "play-and-record", "navigator.audioSession type");
    assert_equals(navigator.audioSession.state, "active", "navigator.audioSession state");
}, "Allow audioSession in iframes where microphone is allowed");
</script>
</body>
