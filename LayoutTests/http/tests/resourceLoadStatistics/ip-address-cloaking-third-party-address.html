<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src="/js-test-resources/js-test.js"></script>
    <script src="/cookies/resources/cookie-utilities.js"></script>
    <script src="resources/util.js"></script>
</head>
<body onload="runTest()">
<script>
    description("Test for IP address cloaking: Apply cookie expiry capping if the sub-resource's IP comes from a different block as the block containing the top frame's IP");
    jsTestIsAsync = true;

    function finishTest() {
        resetCookiesForCurrentOrigin();
        setEnableFeature(false, finishJSTest);
    }

    function checkCookieExpiry(cookieData, seconds, shouldBeLessThan) {
        let now = new Date();
        let expiryDateInMilliseconds = now.getTime() + (seconds * 1000);

        if ((cookieData["expires"] < expiryDateInMilliseconds) === shouldBeLessThan)
            testPassed(`Cookie named ${cookieData["name"]} expires in ${shouldBeLessThan ? "less" : "more"} than ${seconds} seconds.`);
        else
            testFailed(`Cookie named ${cookieData["name"]} expires in ${shouldBeLessThan ? "more" : "less"} than ${seconds} seconds.`);
    }

    const oneWeekInSeconds = 7 * 24 * 60 * 60;
    const overOneWeekInSeconds = oneWeekInSeconds + 600;
    const cookieName = "thirdPartyIPCookie";
    const subPathToSetFirstPartyCookie = `resources/set-cookie.py?name=${cookieName}&value=value&dummy=${Math.random()}`;

    function setAndCheckCookie() {
        fetch(subPathToSetFirstPartyCookie).then(function() {
            if (internals) {
                let cookies = internals.getCookies();
                if (!cookies.length)
                    testFailed("No cookies found.");
                for (let cookie of cookies) {
                    if (cookie.name === cookieName) {
                        checkCookieExpiry(cookie, overOneWeekInSeconds, true);
                    } else {
                        testFailed(`Unknown cookie ${cookie.name} found.`);
                    }
                }
                finishTest();
            }
        });
    }

    const firstParty = "http://127.0.0.1:8000";
    const firstPartyCNAMEForTesting = "http://testwebkit.org";
    const thirdPartyIPAddressForTesting = "10.49.253.10";

    function runTest() {
        setEnableFeature(true, function() {
            testRunner.statisticsSetFirstPartyHostCNAMEDomain(firstParty, firstPartyCNAMEForTesting, function() {
                testRunner.statisticsSetThirdPartyCNAMEDomainAndAddress("", thirdPartyIPAddressForTesting, setAndCheckCookie);
            });
        });
    }
</script>
</body>
