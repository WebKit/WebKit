<html>
<head>
<script src="resources/push-api-test-pre.js"></script>
<script src="resources/subscribe-tests.js"></script>
</head>
<body>
<script>
if (window.testRunner)
    testRunner.denyWebNotificationPermissionOnPrompt(window.origin);

navigator.serviceWorker.register("resources/subscribe-worker.js", { }).then(async (registration) => {
    try {
        await waitForState(registration.installing, "activated");
        await testServiceWorkerPermissionState(registration, 'prompt');
        await testDocumentPermissionState(registration, 'prompt');
        await testServiceWorkerSubscribe(registration, 'NotAllowedError');
        await testDocumentSubscribeWithoutUserGesture(registration, 'NotAllowedError');

        if (!window.internals)
            return;

        var promise;
        internals.withUserGesture(() => {
            promise = registration.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: VALID_SERVER_KEY
            });
        });

        try {
            let result = await(promise);
        } catch (e) {
            if (e == "NotAllowedError: User denied push permission")
                log('PASS: document subscribe with user gesture consumed the user gesture');
            else
                log(`FAIL: document subscribe with user gesture failed with unexpected exception: ${e}`);

            if (!internals.hasTransientActivation())
                log('PASS: there is no transient activation (failed with user gesture error)');
            else
                log(`FAIL: should not have a transient activation`);
        }
    } catch (e) {
        log(`FAIL: unexpected exception ${e}`);
    } finally {
        await registration.unregister();
        finishPushAPITest();
    }
});
</script>
</body>
</html>
