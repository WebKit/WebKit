{"version":3,"file":"dev_server.js","names":["fs","os","path","babel","chokidar","express","morgan","portfinder","serveIndex","makeListing","process","env","STANDALONE_DEV_SERVER","srcDir","resolve","__dirname","babelConfig","require","cache","sourceMaps","listingCache","Map","compileCache","console","log","watcher","watch","persistent","dirtyCompileCache","absPath","stats","relPath","relative","undefined","isFile","endsWith","tsUrl","has","debug","delete","dirtyListingAndCompileCache","segments","split","sep","listingChange","extname","basename","length","suite","on","app","use","req","res","next","header","static","get","params","setHeader","send","listing","result","JSON","stringify","set","err","jsUrl","url","replace","join","existsSync","transformFileAsync","code","Error","host","port","getPort","listen","iface","Object","values","networkInterfaces","details","family","address"],"sources":["../../../src/common/tools/dev_server.ts"],"sourcesContent":["import * as fs from 'fs';\nimport * as os from 'os';\nimport * as path from 'path';\n\nimport * as babel from '@babel/core';\nimport * as chokidar from 'chokidar';\nimport * as express from 'express';\nimport * as morgan from 'morgan';\nimport * as portfinder from 'portfinder';\nimport * as serveIndex from 'serve-index';\n\nimport { makeListing } from './crawl.js';\n\n// Make sure that makeListing doesn't cache imported spec files. See crawl().\nprocess.env.STANDALONE_DEV_SERVER = '1';\n\nconst srcDir = path.resolve(__dirname, '../../');\n\n// Import the project's babel.config.js. We'll use the same config for the runtime compiler.\nconst babelConfig = {\n  ...require(path.resolve(srcDir, '../babel.config.js'))({\n    cache: () => {\n      /* not used */\n    },\n  }),\n  sourceMaps: 'inline',\n};\n\n// Caches for the generated listing file and compiled TS sources to speed up reloads.\n// Keyed by suite name\nconst listingCache = new Map<string, string>();\n// Keyed by the path to the .ts file, without src/\nconst compileCache = new Map<string, string>();\n\nconsole.log('Watching changes in', srcDir);\nconst watcher = chokidar.watch(srcDir, {\n  persistent: true,\n});\n\n/**\n * Handler to dirty the compile cache for changed .ts files.\n */\nfunction dirtyCompileCache(absPath: string, stats?: fs.Stats) {\n  const relPath = path.relative(srcDir, absPath);\n  if ((stats === undefined || stats.isFile()) && relPath.endsWith('.ts')) {\n    const tsUrl = relPath;\n    if (compileCache.has(tsUrl)) {\n      console.debug('Dirtying compile cache', tsUrl);\n    }\n    compileCache.delete(tsUrl);\n  }\n}\n\n/**\n * Handler to dirty the listing cache for:\n *  - Directory changes\n *  - .spec.ts changes\n *  - README.txt changes\n * Also dirties the compile cache for changed files.\n */\nfunction dirtyListingAndCompileCache(absPath: string, stats?: fs.Stats) {\n  const relPath = path.relative(srcDir, absPath);\n\n  const segments = relPath.split(path.sep);\n  // The listing changes if the directories change, or if a .spec.ts file is added/removed.\n  const listingChange =\n    // A directory or a file with no extension that we can't stat.\n    // (stat doesn't work for deletions)\n    ((path.extname(relPath) === '' && (stats === undefined || !stats.isFile())) ||\n      // A spec file\n      relPath.endsWith('.spec.ts') ||\n      // A README.txt\n      path.basename(relPath, 'txt') === 'README') &&\n    segments.length > 0;\n  if (listingChange) {\n    const suite = segments[0];\n    if (listingCache.has(suite)) {\n      console.debug('Dirtying listing cache', suite);\n    }\n    listingCache.delete(suite);\n  }\n\n  dirtyCompileCache(absPath, stats);\n}\n\nwatcher.on('add', dirtyListingAndCompileCache);\nwatcher.on('unlink', dirtyListingAndCompileCache);\nwatcher.on('addDir', dirtyListingAndCompileCache);\nwatcher.on('unlinkDir', dirtyListingAndCompileCache);\nwatcher.on('change', dirtyCompileCache);\n\nconst app = express();\n\n// Send Chrome Origin Trial tokens\napp.use((req, res, next) => {\n  res.header('Origin-Trial', [\n    // Token for http://localhost:8080\n    'AvyDIV+RJoYs8fn3W6kIrBhWw0te0klraoz04mw/nPb8VTus3w5HCdy+vXqsSzomIH745CT6B5j1naHgWqt/tw8AAABJeyJvcmlnaW4iOiJodHRwOi8vbG9jYWxob3N0OjgwODAiLCJmZWF0dXJlIjoiV2ViR1BVIiwiZXhwaXJ5IjoxNjYzNzE4Mzk5fQ==',\n  ]);\n  next();\n});\n\n// Set up logging\napp.use(morgan('dev'));\n\n// Serve the standalone runner directory\napp.use('/standalone', express.static(path.resolve(srcDir, '../standalone')));\n// Add out-wpt/ build dir for convenience\napp.use('/out-wpt', express.static(path.resolve(srcDir, '../out-wpt')));\napp.use('/docs/tsdoc', express.static(path.resolve(srcDir, '../docs/tsdoc')));\n\n// Serve a suite's listing.js file by crawling the filesystem for all tests.\napp.get('/out/:suite/listing.js', async (req, res, next) => {\n  const suite = req.params['suite'];\n\n  if (listingCache.has(suite)) {\n    res.setHeader('Content-Type', 'application/javascript');\n    res.send(listingCache.get(suite));\n    return;\n  }\n\n  try {\n    const listing = await makeListing(path.resolve(srcDir, suite, 'listing.ts'));\n    const result = `export const listing = ${JSON.stringify(listing, undefined, 2)}`;\n\n    listingCache.set(suite, result);\n    res.setHeader('Content-Type', 'application/javascript');\n    res.send(result);\n  } catch (err) {\n    next(err);\n  }\n});\n\n// Serve all other .js files by fetching the source .ts file and compiling it.\napp.get('/out/**/*.js', async (req, res, next) => {\n  const jsUrl = path.relative('/out', req.url);\n  const tsUrl = jsUrl.replace(/\\.js$/, '.ts');\n  if (compileCache.has(tsUrl)) {\n    res.setHeader('Content-Type', 'application/javascript');\n    res.send(compileCache.get(tsUrl));\n    return;\n  }\n\n  let absPath = path.join(srcDir, tsUrl);\n  if (!fs.existsSync(absPath)) {\n    // The .ts file doesn't exist. Try .js file in case this is a .js/.d.ts pair.\n    absPath = path.join(srcDir, jsUrl);\n  }\n\n  try {\n    const result = await babel.transformFileAsync(absPath, babelConfig);\n    if (result && result.code) {\n      compileCache.set(tsUrl, result.code);\n\n      res.setHeader('Content-Type', 'application/javascript');\n      res.send(result.code);\n    } else {\n      throw new Error(`Failed compile ${tsUrl}.`);\n    }\n  } catch (err) {\n    next(err);\n  }\n});\n\nconst host = '0.0.0.0';\nconst port = 8080;\n// Find an available port, starting at 8080.\nportfinder.getPort({ host, port }, (err, port) => {\n  if (err) {\n    throw err;\n  }\n  watcher.on('ready', () => {\n    // Listen on the available port.\n    app.listen(port, host, () => {\n      console.log('Standalone test runner running at:');\n      for (const iface of Object.values(os.networkInterfaces())) {\n        for (const details of iface || []) {\n          if (details.family === 'IPv4') {\n            console.log(`  http://${details.address}:${port}/standalone/`);\n          }\n        }\n      }\n    });\n  });\n});\n\n// Serve everything else (not .js) as static, and directories as directory listings.\napp.use('/out', serveIndex(path.resolve(srcDir, '../src')));\napp.use('/out', express.static(path.resolve(srcDir, '../src')));\n"],"mappings":"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"}