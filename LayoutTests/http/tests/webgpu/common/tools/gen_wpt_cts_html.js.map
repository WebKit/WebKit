{"version":3,"file":"gen_wpt_cts_html.js","names":["promises","fs","DefaultTestFileLoader","TestQueryMultiFile","assert","printUsageAndExit","rc","console","error","process","exit","argv","length","outFile","templateFile","argsPrefixesFile","expectationsFile","expectationsPrefix","suite","argsPrefixes","expectationLines","Set","argsPrefixesFromFile","readFile","split","filter","a","sort","b","l","expectations","Map","prefix","set","expLoop","exp","argsPrefix","startsWith","get","push","substring","log","loader","lines","rootQuery","tree","loadTree","undefined","alwaysExpandThroughLevel","query","iterateCollapsedNodes","urlQueryString","toString","generateFile","catch","ex","stack","result","line","writeFile"],"sources":["../../../src/common/tools/gen_wpt_cts_html.ts"],"sourcesContent":["import { promises as fs } from 'fs';\n\nimport { DefaultTestFileLoader } from '../internal/file_loader.js';\nimport { TestQueryMultiFile } from '../internal/query/query.js';\nimport { assert } from '../util/util.js';\n\nfunction printUsageAndExit(rc: number): void {\n  console.error(`\\\nUsage:\n  tools/gen_wpt_cts_html OUTPUT_FILE TEMPLATE_FILE [ARGUMENTS_PREFIXES_FILE EXPECTATIONS_FILE EXPECTATIONS_PREFIX [SUITE]]\n  tools/gen_wpt_cts_html out-wpt/cts.https.html templates/cts.https.html\n  tools/gen_wpt_cts_html my/path/to/cts.https.html templates/cts.https.html arguments.txt myexpectations.txt 'path/to/cts.https.html' cts\n\nwhere arguments.txt is a file containing a list of arguments prefixes to both generate and expect\nin the expectations. The entire variant list generation runs *once per prefix*, so this\nmultiplies the size of the variant list.\n\n  ?worker=0&q=\n  ?worker=1&q=\n\nand myexpectations.txt is a file containing a list of WPT paths to suppress, e.g.:\n\n  path/to/cts.https.html?worker=0&q=webgpu:a/foo:bar={\"x\":1}\n  path/to/cts.https.html?worker=1&q=webgpu:a/foo:bar={\"x\":1}\n\n  path/to/cts.https.html?worker=1&q=webgpu:a/foo:bar={\"x\":3}\n`);\n  process.exit(rc);\n}\n\nif (process.argv.length !== 4 && process.argv.length !== 7 && process.argv.length !== 8) {\n  printUsageAndExit(0);\n}\n\nconst [\n  ,\n  ,\n  outFile,\n  templateFile,\n  argsPrefixesFile,\n  expectationsFile,\n  expectationsPrefix,\n  suite = 'webgpu',\n] = process.argv;\n\n(async () => {\n  let argsPrefixes = [''];\n  let expectationLines = new Set<string>();\n\n  if (process.argv.length >= 7) {\n    // Prefixes sorted from longest to shortest\n    const argsPrefixesFromFile = (await fs.readFile(argsPrefixesFile, 'utf8'))\n      .split(/\\r?\\n/)\n      .filter(a => a.length)\n      .sort((a, b) => b.length - a.length);\n    if (argsPrefixesFromFile.length) argsPrefixes = argsPrefixesFromFile;\n    expectationLines = new Set(\n      (await fs.readFile(expectationsFile, 'utf8')).split(/\\r?\\n/).filter(l => l.length)\n    );\n  }\n\n  const expectations: Map<string, string[]> = new Map();\n  for (const prefix of argsPrefixes) {\n    expectations.set(prefix, []);\n  }\n\n  expLoop: for (const exp of expectationLines) {\n    // Take each expectation for the longest prefix it matches.\n    for (const argsPrefix of argsPrefixes) {\n      const prefix = expectationsPrefix + argsPrefix;\n      if (exp.startsWith(prefix)) {\n        expectations.get(argsPrefix)!.push(exp.substring(prefix.length));\n        continue expLoop;\n      }\n    }\n    console.log('note: ignored expectation: ' + exp);\n  }\n\n  const loader = new DefaultTestFileLoader();\n  const lines: Array<string | undefined> = [];\n  for (const prefix of argsPrefixes) {\n    const rootQuery = new TestQueryMultiFile(suite, []);\n    const tree = await loader.loadTree(rootQuery, expectations.get(prefix));\n\n    lines.push(undefined); // output blank line between prefixes\n    const alwaysExpandThroughLevel = 2; // expand to, at minimum, every test.\n    for (const { query } of tree.iterateCollapsedNodes({ alwaysExpandThroughLevel })) {\n      const urlQueryString = prefix + query.toString(); // \"?worker=0&q=...\"\n      // Check for a safe-ish path length limit. Filename must be <= 255, and on Windows the whole\n      // path must be <= 259. Leave room for e.g.:\n      // 'c:\\b\\s\\w\\xxxxxxxx\\layout-test-results\\external\\wpt\\webgpu\\cts_worker=0_q=...-actual.txt'\n      assert(\n        urlQueryString.length < 185,\n        'Generated test variant would produce too-long -actual.txt filename. \\\nTry broadening suppressions to avoid long test variant names. ' +\n          urlQueryString\n      );\n      lines.push(urlQueryString);\n    }\n  }\n  await generateFile(lines);\n})().catch(ex => {\n  console.log(ex.stack ?? ex.toString());\n  process.exit(1);\n});\n\nasync function generateFile(lines: Array<string | undefined>): Promise<void> {\n  let result = '';\n  result += '<!-- AUTO-GENERATED - DO NOT EDIT. See WebGPU CTS: tools/gen_wpt_cts_html. -->\\n';\n\n  result += await fs.readFile(templateFile, 'utf8');\n\n  for (const line of lines) {\n    if (line === undefined) {\n      result += '\\n';\n    } else {\n      result += `<meta name=variant content='${line}'>\\n`;\n    }\n  }\n\n  await fs.writeFile(outFile, result);\n}\n"],"mappings":"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"}