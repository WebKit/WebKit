<!DocType html>
<style>
body {
    margin: 4px;
}

body > p:first-of-type {
    margin-top: 0;
}

p {
    margin-bottom: 0.3em;
}

tbody tr:first-of-type:hover {
    opacity: 0.7;
}

tr:not(.results-row) td {
    white-space: nowrap;
}

tr:not(.results-row) td:first-of-type {
    white-space: normal;
}

td:not(:first-of-type) {
    text-transform: lowercase;
}

td {
    padding: 0 4px;
}

th:empty, td:empty {
    padding: 0;
}

th {
    -webkit-user-select: none;
    -moz-user-select: none;
}

label {
    margin-left: 10px;
}

.results-row {
    background-color: white;
}

.results-row iframe {
    width: 800px;
    height: 600px;
}

#options {
    position: absolute;
    top: 4px;
    right: 4px;
}

.expand-button {
    background-color: white;
    color: blue;
    width: 11px;
    height: 11px;
    border: 1px solid blue;
    display: inline-block;
    margin: 0 3px 0 0;
    position: relative;
}

.expand-button-text {
    position: absolute;
    top: -0.3em;
    left: 1px;
}

.result-container {
    display: inline-block;
    border: 1px solid gray;
}

.result-container iframe, .result-container img {
    border: 0;
    border-top: 1px solid lightgray;
    vertical-align: top;
}

#options {
    background-color: white;
}

.label {
    padding-left: 3px;
    font-weight: bold;
    font-size: small;
}

.pixel-zoom-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    display: -webkit-box;
}

.pixel-zoom-container > * {
    display: -webkit-box;
    -webkit-box-flex: 1;
    border: 1px inset lightgray;
    height: 100px;
    overflow: hidden;
    zoom: 300%;
    background-color: white;
}

.pixel-zoom-container img {
    width: 800px;
    height: 600px;
    vertical-align: top;
}
</style>
<style id="unexpected-style"></style>

<script>
var g_state;
function globalState()
{
    if (!g_state) {
        g_state = {
            hasHttpTests: false,
            hasImageFailures: false,
            hasTextFailures: false,
            newTests: [],
            results: {},
            testsWithStderr: [],
            unexpectedPassTests: []
        }
    }
    return g_state;
}

function ADD_RESULTS(input)
{
    globalState().results = input;
}
</script>

<script src="full_results.json"></script>

<script>
function stripExtension(test)
{
    var index = test.lastIndexOf('.');
    return test.substring(0, index);
}

function parentOfType(node, selector)
{
    while (node = node.parentElement) {
        if (node.webkitMatchesSelector(selector))
            return node;
    }
    return null;
}

function appendResultIframe(src, parent)
{
    // FIXME: use audio tags for AUDIO tests?
    var layoutTestsIndex = src.indexOf('LayoutTests');
    var name;
    if (layoutTestsIndex != -1) {
        var hasTrac = src.indexOf('trac.webkit.org') != -1;
        var prefix = hasTrac ? 'trac.webkit.org/.../' : '';
        name = prefix + src.substring(layoutTestsIndex + 'LayoutTests/'.length);
    } else {
        var lastDashIndex = src.lastIndexOf('-pretty');
        if (lastDashIndex == -1)
            lastDashIndex = src.lastIndexOf('-');
        name = src.substring(lastDashIndex + 1);
    }

    var tagName = (src.lastIndexOf('.png') == -1) ? 'iframe' : 'img';

    var container = document.createElement('div');
    container.className = 'result-container';
    container.innerHTML = '<div class=label>' + name + '</div><' + tagName + ' src="' + src + '?format=txt"></' + tagName + '>';
    parent.appendChild(container);
}

function toggleExpectations(e)
{
    var expandLink = e.target;
    if (expandLink.className != 'expand-button-text')
        expandLink = expandLink.querySelector('.expand-button-text');

    if (expandLink.textContent == '+')
        expandExpectations(expandLink);
    else
        collapseExpectations(expandLink);
}

function collapseExpectations(expandLink)
{
    expandLink.textContent = '+';
    var existingResultsRow = parentOfType(expandLink, 'tbody').querySelector('.results-row');
    if (existingResultsRow)
        existingResultsRow.style.display = 'none';
}

function expandExpectations(expandLink)
{
    var row = parentOfType(expandLink, 'tr');
    var parentTbody = row.parentNode;
    var existingResultsRow = parentTbody.querySelector('.results-row');
    
    var enDash = '\u2013';
    expandLink.textContent = enDash;
    if (existingResultsRow) {
        existingResultsRow.style.display = '';
        return;
    }
    
    var newRow = document.createElement('tr');
    newRow.className = 'results-row';
    var newCell = document.createElement('td');
    newCell.colSpan = row.querySelectorAll('td').length;

    appendResultIframe(row.querySelector('.test-link').href, newCell);

    var resultLinks = row.querySelectorAll('.result-link');
    for (var i = 0; i < resultLinks.length; i++)
        appendResultIframe(resultLinks[i].href, newCell);

    newRow.appendChild(newCell);
    parentTbody.appendChild(newRow);
}

function async(func, args)
{
    setTimeout(function() { func.apply(null, args); }, 100);
}

function visibleExpandLinks()
{
    if (onlyShowUnexpectedFailures())
        return document.querySelectorAll('tbody:not(.expected) .expand-button-text');
    else
        return document.querySelectorAll('.expand-button-text');
}

function expandAllExpectations()
{
    var expandLinks = visibleExpandLinks();
    for (var i = 0, len = expandLinks.length; i < len; i++)
        async(expandExpectations, [expandLinks[i]]);
}

function collapseAllExpectations()
{
    var expandLinks = visibleExpandLinks();
    for (var i = 0, len = expandLinks.length; i < len; i++)
        async(collapseExpectations, [expandLinks[i]]);
}

function shouldUseTracLinks()
{
    return !globalState().results.layout_tests_dir || !location.toString().indexOf('file://') == 0;
}

function testLink(test)
{
    var basePath;
    if (shouldUseTracLinks()) {
        var revision = globalState().results.revision;
        basePath = 'http://trac.webkit.org';
        basePath += revision ? ('/export/' + revision) : '/browser';
        basePath += '/trunk/LayoutTests/';
    } else
        basePath = globalState().results.layout_tests_dir + '/';
    return '<span class=expand-button onclick="toggleExpectations(event)"><span class=expand-button-text>+</span></span>' +
        '<a class=test-link href="' + basePath + test + '">' + test + '</a>';
}

function resultLink(testPrefix, suffix, contents)
{
    return '<a class=result-link href="' + testPrefix + suffix + '">' + contents + '</a> ';
}

function testObjectFor(test)
{
    var parts = test.split('/');
    var tree = globalState().results.tests;
    for (var i = 0; i < parts.length; i++) {
        if (parts[i] in tree)
            tree = tree[parts[i]];
        else {
            console.error('Test not in the results tree: ' + test);
            return null;
        }
    }
    return tree;
}

function processGlobalStateFor(testObject)
{
    var test = testObject.name;
    if (testObject.has_stderr)
        globalState().testsWithStderr.push(test);

    globalState().hasHttpTests = globalState().hasHttpTests || test.indexOf('http/') == 0;

    var actual = testObject.actual;
    if (actual == 'MISSING') {
        // FIXME: make sure that new-run-webkit-tests spits out an -actual.txt file for
        // tests with MISSING results.
        globalState().newTests.push(test);
        return;
    }
    
    var expected = testObject.expected || 'PASS';
    testObject.isExpected = true;
    if (actual != 'SKIP' && globalState().results.uses_expectations_file) {
        var expectedArray = expected.split(' ');
        var actualArray = actual.split(' ');
        for (var i = 0; i < actualArray.length; i++) {
            var actualValue = actualArray[i];
            if (expectedArray.indexOf(actualValue) == -1 &&
                (expectedArray.indexOf('FAIL') == -1 ||
                 (actualValue != 'IMAGE' && actualValue != 'TEXT' && actualValue != 'IMAGE+TEXT')))
                testObject.isExpected = false;
        }
    }

    if (actual == 'PASS' && expected != 'PASS')
        globalState().unexpectedPassTests.push(test);            
}

function tableRow(testObject)
{    
    var row = '<tbody'
    if (globalState().results.uses_expectations_file)
        row += ' class="' + (testObject.isExpected ? 'expected' : '') + '"';
    row += '><tr>';

    row += '<td>' + testLink(testObject.name) + '</td>';

    var test_prefix = stripExtension(testObject.name);
    row += '<td>';
    
    var actual = testObject.actual;
    if (actual.indexOf('TEXT') != -1 || actual.indexOf('TIMEOUT') != -1) {
        // FIXME: only include timeout actual/expected results here if we actually spit out results for timeout tests.
        globalState().hasTextFailures = true;
        row += resultLink(test_prefix, '-expected.txt', 'expected') +
            resultLink(test_prefix, '-actual.txt', 'actual') +
            resultLink(test_prefix, '-diff.txt', 'diff');
  
        if (globalState().results.has_pretty_patch)
            row += resultLink(test_prefix, '-pretty-diff.html', 'pretty diff');

        if (globalState().results.has_wdiff)
            row += resultLink(test_prefix, '-wdiff.html', 'wdiff');
    }

    if (actual.indexOf('CRASH') != -1)
        row += resultLink(test_prefix, '-stack.txt', 'stack');
    
    if (actual.indexOf('AUDIO') != -1) {
        row += resultLink(test_prefix, '-expected.wav', 'expected audio');
        row += resultLink(test_prefix, '-actual.wav', 'actual audio');
    }

    row += '</td><td>';

    if (actual.indexOf('IMAGE') != -1) {
        globalState().hasImageFailures = true;

        if (testObject.is_mismatch_reftest) {
            row += resultLink(test_prefix, '-expected-mismatch.html', 'ref mismatch html') +
                resultLink(test_prefix, '-actual.png', 'actual');
        } else {
            if (testObject.is_reftest)
                row += resultLink(test_prefix, '-expected.html', 'ref html');

            row += resultLink(test_prefix, '-expected.png', 'expected') +
                resultLink(test_prefix, '-actual.png', 'actual') +
                resultLink(test_prefix, '-diff.png', 'diff');
        }
    }

    row += '</td>';
    row += '<td>' + actual + '</td>';

    if (globalState().results.uses_expectations_file)
      row += '<td>' + testObject.expected + '</td>';

    row += '</tr></tbody>';
    return row;
}

function forEachTest(handler, opt_tree, opt_prefix)
{
    var tree = opt_tree || globalState().results.tests;
    var prefix = opt_prefix || '';

    for (var key in tree) {
        var newPrefix = prefix ? (prefix + '/' + key) : key;
        if ('actual' in tree[key]) {
            var testObject = tree[key];
            testObject.name = newPrefix;
            handler(testObject);
        } else
            forEachTest(handler, tree[key], newPrefix);
    }
}

function tableRows()
{
    var html = '';
    forEachTest(function(testObject) {
        processGlobalStateFor(testObject)
        var test = testObject.name;
        if (globalState().unexpectedPassTests.indexOf(test) == -1 &&
            globalState().newTests.indexOf(test) == -1)
            html += tableRow(testObject);
    });
    return html;
}

function testList(tests, header, tableId)
{
    tests.sort();

    var html = '<p>' + header + '</p><table id="' + tableId + '">';

    if (tableId == 'passes-table')
        html += '<thead><th>test</th><th>expected failure type</th>';

    for (var i = 0; i < tests.length; i++) {
        var test = tests[i];
        html += '<tbody><tr><td>' + testLink(test) + '</td><td>';
        
        if (tableId == 'stderr-table')
            html += resultLink(stripExtension(test), '-stderr.txt', 'stderr');
        else if (tableId == 'passes-table')
            html += testObjectFor(test).expected;
        else if (tableId == 'new-tests-table') {
            var testObject = testObjectFor(test);
            if (testObject.is_missing_audio)
                html += resultLink(stripExtension(test), '-actual.wav', 'audio result');
            if (testObject.is_missing_text)
                html += resultLink(stripExtension(test), '-actual.txt', 'result');
            if (testObject.is_missing_image)
                html += resultLink(stripExtension(test), '-actual.png', 'png result');
        } 
        
        html += '</td></tr></tbody>';
    }
    html += '</table>';
    return html;
}

function toArray(nodeList)
{
    return Array.prototype.slice.call(nodeList);
}

function trim(string)
{
    return string.replace(/^[\s\xa0]+|[\s\xa0]+$/g, '');
}

// Just a namespace for code management.
var TableSorter = {};

TableSorter._forwardArrow = '<svg style="width:10px;height:10px"><polygon points="0,0 10,0 5,10" style="fill:#ccc"></svg>';

TableSorter._backwardArrow = '<svg style="width:10px;height:10px"><polygon points="0,10 10,10 5,0" style="fill:#ccc"></svg>';

TableSorter._sortedContents = function(header, arrow)
{
    return arrow + ' ' + trim(header.textContent) + ' ' + arrow;
}

TableSorter._updateHeaderClassNames = function(newHeader)
{
    var sortHeader = document.querySelector('.sortHeader');
    if (sortHeader) {
        if (sortHeader == newHeader) {
            var isAlreadyReversed = sortHeader.classList.contains('reversed');
            if (isAlreadyReversed)
                sortHeader.classList.remove('reversed');
            else
                sortHeader.classList.add('reversed');
        } else {
            sortHeader.textContent = sortHeader.textContent;
            sortHeader.classList.remove('sortHeader');
            sortHeader.classList.remove('reversed');
        }
    }

    newHeader.classList.add('sortHeader');
}

TableSorter._textContent = function(tbodyRow, column)
{
    return tbodyRow.querySelectorAll('td')[column].textContent;
}

TableSorter._sortRows = function(newHeader, reversed)
{
    var testsTable = document.getElementById('results-table');
    var headers = toArray(testsTable.querySelectorAll('th'));
    var sortColumn = headers.indexOf(newHeader);

    var rows = toArray(testsTable.querySelectorAll('tbody'));

    rows.sort(function(a, b) {
        // Only need to support lexicographic sort for now.
        var aText = TableSorter._textContent(a, sortColumn);
        var bText = TableSorter._textContent(b, sortColumn);
        
        // Forward sort equal values by test name.
        if (sortColumn && aText == bText) {
            var aTestName = TableSorter._textContent(a, 0);
            var bTestName = TableSorter._textContent(b, 0);
            if (aTestName == bTestName)
                return 0;
            return aTestName < bTestName ? -1 : 1;
        }

        if (reversed)
            return aText < bText ? 1 : -1;
        else
            return aText < bText ? -1 : 1;
    });

    for (var i = 0; i < rows.length; i++)
        testsTable.appendChild(rows[i]);
}

TableSorter.sortColumn = function(columnNumber)
{
    var newHeader = document.getElementById('results-table').querySelectorAll('th')[columnNumber];
    TableSorter._sort(newHeader);
}

TableSorter.handleClick = function(e)
{
    var newHeader = e.target;
    if (newHeader.localName != 'th')
        return;
    TableSorter._sort(newHeader);
}

TableSorter._sort = function(newHeader)
{
    TableSorter._updateHeaderClassNames(newHeader);
    
    var reversed = newHeader.classList.contains('reversed');
    var sortArrow = reversed ? TableSorter._backwardArrow : TableSorter._forwardArrow;
    newHeader.innerHTML = TableSorter._sortedContents(newHeader, sortArrow);
    
    TableSorter._sortRows(newHeader, reversed);
}

var PixelZoomer = {};

PixelZoomer.showOnDelay = true;

PixelZoomer._createContainer = function(e)
{
    var tbody = parentOfType(e.target, 'tbody');
    var imageDiffLinks = tbody.querySelector('tr').querySelectorAll('a[href$=".png"]');
    
    var container = document.createElement('div');
    container.className = 'pixel-zoom-container';
    
    var html = '';
    for (var i = 0; i < imageDiffLinks.length; i++)
        html += '<div class=zoom-image-container><img src="' + imageDiffLinks[i].href + '"></div>';
    
    container.innerHTML = html;
    document.body.appendChild(container);

    PixelZoomer._position(e);
}

PixelZoomer._position = function(e)
{
    var pageX = e.clientX;
    var pageY = e.clientY;
    var targetLocation = e.target.getBoundingClientRect();
    var x = pageX - targetLocation.left;
    var y = pageY - targetLocation.top;

    var zoomContainers = document.querySelectorAll('.pixel-zoom-container > .zoom-image-container');
    for (var i = 0; i < zoomContainers.length; i++) {
        var container = zoomContainers[i];
        container.scrollLeft = x - container.offsetWidth / 2;
        container.scrollTop = y - container.offsetHeight / 2;
    }
}

PixelZoomer.handleMouseMove = function(e) {
    if (PixelZoomer._mouseMoveTimeout)
        clearTimeout(PixelZoomer._mouseMoveTimeout);

    if (parentOfType(e.target, '.pixel-zoom-container'))
        return;

    var container = document.querySelector('.pixel-zoom-container');
    if (!e.target.src || e.target.src.indexOf('.png') == -1) {
        if (container)
            container.parentNode.removeChild(container);
        return;
    }
    
    if (!container) {
        if (PixelZoomer.showOnDelay) {
            PixelZoomer._mouseMoveTimeout = setTimeout(function() {
                PixelZoomer._createContainer(e);
            }, 200);
            return;
        }

        PixelZoomer._createContainer(e);
        return;
    }
    
    PixelZoomer._position(e);
}

document.addEventListener('mousemove', PixelZoomer.handleMouseMove, false);

function onlyShowUnexpectedFailures()
{
    var checkBox = document.querySelector('.unexpected-results');
    return !checkBox || checkBox.checked;
}

function updateExpectedFailures()
{
    document.getElementById('unexpected-style').innerText = onlyShowUnexpectedFailures() ?
        '.expected { display: none; }' : '';
}

function generatePage()
{
    var html = '<div id=options>' +
        '<a href="javascript:void()" class="expand-all" onclick="expandAllExpectations()">expand all</a> ' +
        '<a href="javascript:void()" class="collapse-all" onclick="collapseAllExpectations()">collapse all</a>';

    if (globalState().results.uses_expectations_file)
        html += '<label><input class="unexpected-results" type=checkbox checked onchange="updateExpectedFailures()">Only show unexpected results</label>';

    html += '</div>';

    var tableRowsHtml = tableRows();

    if (tableRowsHtml) {
        html += '<p>Tests where results did not match expected results:</p>' +
            '<table id="results-table"><thead><tr>' +
            '<th>test</th>' +
            '<th id="text-results-header">text results</th>' +
            '<th id="image-results-header">image results</th>' +
            '<th>failure type</th>';

        if (globalState().results.uses_expectations_file)
            html += '<th>expected failure type</th>';

        html += '</tr></thead>' + tableRowsHtml + '</table>';
    }

    if (globalState().newTests.length)
        html += testList(globalState().newTests, 'Tests that had no expected results (probably new):', 'new-tests-table');

    if (globalState().testsWithStderr.length)
        html += testList(globalState().testsWithStderr, 'Tests that had stderr output:', 'stderr-table');

    if (globalState().unexpectedPassTests.length)
        html += testList(globalState().unexpectedPassTests, 'Tests expected to fail but passed:', 'passes-table');

    if (globalState().hasHttpTests) {
        html += '<p>httpd access log: <a href="access_log.txt">access_log.txt</a></p>' +
            '<p>httpd error log: <a href="error_log.txt">error_log.txt</a></p>';
    }

    document.body.innerHTML = html;

    if (document.getElementById('results-table')) {
        document.getElementById('results-table').addEventListener('click', TableSorter.handleClick, false);
        TableSorter.sortColumn(0);
        if (!globalState().hasTextFailures)
            document.getElementById('text-results-header').textContent = '';
        if (!globalState().hasImageFailures)
            document.getElementById('image-results-header').textContent = '';
    }
    
    updateExpectedFailures();
}
</script>
<!-- HACK: when json_results_test.js is included, loading this page runs the tests.
It is not copied to the layout-test-results output directory. -->
<script src="resources/results-test.js"></script>
<body onload="generatePage()"></body>
