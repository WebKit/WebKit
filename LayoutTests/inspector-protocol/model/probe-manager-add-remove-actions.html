<!doctype html>
<html>
<head>
<script type="text/javascript" src="../../http/tests/inspector-protocol/resources/protocol-test.js"></script>
<script src="../debugger/resources/breakpoint.js"></script>
<script>
function test()
{
    InspectorTest.importScript("../../../../inspector-protocol/resources/probe-helper.js");
    InspectorTest.initializeInspectorModels();

    var currentTicks = 0;
    const expectedTicks = 2;

    function incrementTick(event)
    {
        InspectorTest.log("Hit test checkpoint event #" + currentTicks + " with type: " + event.type);
        if (++currentTicks === expectedTicks)
            InspectorTest.completeTest();
    }

    WebInspector.Probe.addEventListener(WebInspector.Probe.Event.SampleAdded, incrementTick);

    ProbeHelper.installTracingListeners();

    WebInspector.debuggerManager.addEventListener(WebInspector.DebuggerManager.Event.ScriptAdded, function(event) {

        var scriptObject = event.data.script;

        if (!/resources\/breakpoint\.js$/.test(scriptObject.url))
            return;

        var location = scriptObject.createSourceCodeLocation(18, 0);
        // For this test, first create the breakpoint and its actions before sending anything to the backend.
        var breakpoint = new WebInspector.Breakpoint(location);
        breakpoint.autoContinue = true;
        // Create two related actions.
        for (var i of [0, 1])
            var action = breakpoint.createAction(WebInspector.BreakpointAction.Type.Probe, null, "a");

        WebInspector.debuggerManager.addBreakpoint(breakpoint);

        breakpoint.addEventListener(WebInspector.Breakpoint.Event.ResolvedStateDidChange, function() {
            InspectorTest.assert(breakpoint.resolved, "Breakpoint should be resolved.");
            InspectorTest.sendCommand("Runtime.evaluate", {expression: "breakpointActions(12, {x:1,y:2})"});
        });
    });
}
</script>
</head>
<body onload="runTest()">
    <p>Testing that the probe manager properly handles addition and removal of related probes.</p>
</body>
</html>
